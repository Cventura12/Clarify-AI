generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Request {
  id            String   @id @default(cuid())
  rawInput      String   @db.Text
  requestCount  Int      @default(1)
  crossTaskDeps Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tasks         Task[]
}

model Task {
  id                 String   @id @default(cuid())
  requestId          String
  request            Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  title              String
  summary            String   @db.Text
  domain             String
  urgency            String
  complexity         String

  entities           Json
  dates              Json
  status             Json
  ambiguities        Json
  hiddenDependencies Json

  taskStatus         String   @default("interpreted")
  confidenceScore    Float    @default(0.5)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  plan               Plan?
}

model Plan {
  id                    String   @id @default(cuid())
  taskId                String   @unique
  task                  Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  totalSteps            Int
  estimatedTotalEffort  String
  deadline              DateTime?

  delegationSummary     Json
  riskFlags             Json
  nextAction            Json
  confidenceScore       Float    @default(0.5)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  steps                 Step[]
  runs                  PlanRun[]
}

model PlanRun {
  id                  String   @id @default(cuid())
  planId              String
  plan                Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  executedCount       Int
  skippedUnauthorized Int
  skippedDependencies Int
  totalSteps          Int
  status              String   @default("completed")
  createdAt           DateTime @default(now())
}

model Step {
  id            String   @id @default(cuid())
  planId        String
  plan          Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  stepNumber    Int
  action        String   @db.Text
  detail        String   @db.Text
  dependencies  Json
  effort        String
  delegation    String
  suggestedDate DateTime?
  status        String   @default("pending")

  authorizedAt  DateTime?
  completedAt   DateTime?
  outcome       String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  executionLogs ExecutionLog[]
  fileArtifacts FileArtifact[]
}

model ExecutionLog {
  id        String   @id @default(cuid())
  stepId    String
  step      Step     @relation(fields: [stepId], references: [id], onDelete: Cascade)
  action    String
  status    String
  actor     String
  detail    Json?
  createdAt DateTime @default(now())
}

model FileArtifact {
  id          String   @id @default(cuid())
  name        String
  type        String
  source      String   @default("system")
  url         String
  contentType String?
  contentText String?  @db.Text
  stepId      String?
  step        Step?    @relation(fields: [stepId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
}

model UserProfile {
  id             String   @id @default(cuid())
  fullName       String?
  email          String?
  phone          String?
  address        String?
  city           String?
  state          String?
  postalCode     String?
  country        String?
  school         String?
  graduationYear String?
  gpa            String?
  linkedIn       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model UserPreference {
  id        String   @id @default(cuid())
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContextNode {
  id        String   @id @default(cuid())
  label     String
  type      String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fromEdges ContextEdge[] @relation("FromNode")
  toEdges   ContextEdge[] @relation("ToNode")
}

model ContextEdge {
  id        String   @id @default(cuid())
  fromId    String
  toId      String
  relation  String
  createdAt DateTime @default(now())

  from      ContextNode @relation("FromNode", fields: [fromId], references: [id], onDelete: Cascade)
  to        ContextNode @relation("ToNode", fields: [toId], references: [id], onDelete: Cascade)
}

model MemoryEntry {
  id        String   @id @default(cuid())
  type      String
  content   String   @db.Text
  source    String   @default("system")
  requestId String?
  createdAt DateTime @default(now())
}

model Integration {
  id        String   @id @default(cuid())
  provider  String   @unique
  status    String   @default("disconnected")
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events    IntegrationEvent[]
  syncs     IntegrationSync[]
}

model IntegrationEvent {
  id            String       @id @default(cuid())
  integrationId String
  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  eventType     String
  payload       Json?
  receivedAt    DateTime     @default(now())
}

model IntegrationSync {
  id            String       @id @default(cuid())
  integrationId String
  integration   Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  status        String
  message       String?
  result        Json?
  createdAt     DateTime     @default(now())
}
